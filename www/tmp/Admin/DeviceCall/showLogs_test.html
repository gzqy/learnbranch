<include file = "./tmp/Admin/Public/common.html" />
<include file = "./tmp/Admin/Device/optionCss.html" />
<include file = "./tmp/Admin/Public/list.html" />
<div class="content" style="background-color: #fff;">
    <div class="con">
        <dl class="nav">
            <dt><b>●</b>设备管理</dt>
            <dd class="bg"><a href="{:U('/Device/status')}"><b>●</b>设备状态</a></dd>
            <dd><a href="{:U('/Admin/Device/uploadStatus')}"><b>●</b>是否上传</a></dd>
        </dl>
        <div class="right" style="width:88.5%;">
            <div class="aps-tab-bar aps-tab-bar-type-card aps-tab-bar-align-left aps-tab-bar-size-small">
                <div class="aps-tab-bar-wrapper" style="width: 100%;">
                    <div class="aps-tab-item-wrapper">
                             <div class="aps-tab-label  aps-tab-label-col-5">
                                <span class="aps-tab-label-inner"><a class="tabs" href="{:U('/Admin/Device/showLine',array('id'=>$this_device))}">设备端口</a></span>
                            </div>
                            <div class="aps-tab-label aps-tab-label-active aps-tab-label-col-5">
                                <span class="aps-tab-label-inner"><a class="tabs" href="javascript:;">设备记录</a></span>
                            </div>
                            
                    </div>
                </div>
            </div>
            <include file = "./tmp/Admin/Device/top.html" />
             <form class="clearfix search" id="_form1" name="_form" method="post" action="{:U('/Admin/Device/showLogs',array('id'=>$this_device))}">
                <input type="hidden" name="id" value="{$id}">
                    <div class="filter">
                        <div class="aps-widget aps-ani-transition aps-grid aps-grid-fluid aps-state-visible">
                            <div class="aps-ani-transition aps-grid-row aps-state-visible">
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 通话时长:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" placeholder="最小值 单位：s" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="start_call_time" value="{$start_call_time}"></div>

                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 通话时长:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" placeholder="最大值 单位：s" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="end_call_time" value="{$end_call_time}"></div>

                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 电话号码:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" placeholder="来电或者拨打的号码" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="tel" value="{$tel}"></div>

                                <!--<div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 录音时间:</div>-->
                                <!--<div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" placeholder="最小值 单位：s" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="min_recording" value="{$min_recording}"></div>-->

                                <!--<div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 录音时间:</div>-->
                                <!--<div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" placeholder="最大值 单位：s" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="max_recording" value="{$max_recording}"></div>-->
                            </div>
                            
                            <div class="aps-ani-transition aps-grid-row aps-state-visible">

                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 记录类型:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;">
                                    <select name="search_type" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small">
                                            <option value="0">选择录音类型</option>
                                            <option value="9" <?php if ($search_type == 9) { echo 'selected'; } ?> >去电记录</option>
                                            <option value="10" <?php if ($search_type == 10) { echo 'selected'; } ?> >来电记录</option>
                                            <option value="11" <?php if ($search_type == 11) { echo 'selected'; } ?> >未接来电</option>
                                            <option value="28" <?php if ($search_type == 28) { echo 'selected'; } ?> >音频记录</option>
                                            <option value="29" <?php if ($search_type == 29) { echo 'selected'; } ?> >来电留言</option>
                                            <option value="50" <?php if ($search_type == 50) { echo 'selected'; } ?> >现场视频</option>
                                    </select>
                                </div>
                                
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 选择端口:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;">
                                    <select  name="search_line"  class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small">
                                    <option value="0">全部端口</option>
                                        <foreach name="lines" item="vo">

                                            <if condition="$vo['code'] eq $search_line">
                                                <option selected value="{$vo.code}">{$vo.code}{$vo.portname}</option>
                                            <else />
                                                <option value="{$vo.code}">{$vo.code}{$vo.portname}</option>
                                            </if>
                                        </foreach>
                                    </select>
                                </div>

                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 文件查询:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" placeholder="旧录音查询文件名称" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="callnotes" value="{$callnotes}"></div>
                            </div>

                            <div class="aps-ani-transition aps-grid-row aps-state-visible">
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 关键名词:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" placeholder="请填写关键名词" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="keywords" value="{$keywords}"></div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 录音日期:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" id="start-one" placeholder="最小值" class="datainp aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="start_date" value="{$start_date}" readonly></div>    

                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 录音日期:</div>
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-4 aps-state-visible" style="padding: 8px;"><input type="text" id="start-two" placeholder="最大值" class=" datainp aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-input aps-size-small" name="end_date" value="{$end_date}" readonly></div>

                            </div>
                            <!-- 隐藏域存储所选水平品种的ID -->
                            <!--<input type="hidden" name="search_line" id="fruits" value="<?=$search_line?>"/>-->
                            <!--<div class="aps-ani-transition aps-grid-col aps-grid-col-md-2 aps-state-visible legend title" style="padding: 8px;"> 选择端口:</div>-->
                            <!--　　<div class="box1">-->
                                    <!--<span class="fruit1_ul1" style="color: #666"><?=$search_line_txt?$search_line_txt:'&nbsp请选择端口'?></span>-->
                                    <!--<ul class="multiFruit1">-->
                                    <!--</ul>-->
                                <!--</div>-->

                            <div class="aps-ani-transition aps-grid-row aps-state-visible">
                                <div class="aps-ani-transition aps-grid-col aps-grid-col-md-24 aps-state-visible search-button" style="padding: 8px;">
                                    <button type="button" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-btn aps-btn-primary aps-size-small btn" onclick="$('#_form1').submit();">搜索</button>
                                    <button type="button" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-btn aps-btn-normal aps-size-small btn" onclick="reset1()">重置</button>
                                    <button type="button" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-btn aps-btn-normal aps-size-small btn float-btn" onclick="excel('{:U('Device/logs_excel')}')">导出列表</button>
                                    <button  type="button" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-btn aps-btn-normal aps-size-small btn float-btn"  onclick="downloadFiles();">批量下载</button>
                                </div>
                            </div>
                        </div>
                    </div>
            </form>
             <input type="hidden" name="gdata" id="gdata" value='{$gdata}' />
            <div  class="formation clearfix" style="margin-top: 10px;width:100%;overflow:hidden;">
                <table>
                    <tr>
                        <th style="width: 20px"><input type="checkbox" name="to_all" id="_to_all" onclick="$('._ids').prop('checked',$(this).prop('checked'))" ></th>
                            <th style="width: 70px">端口</th>
                            <th style="width: 70px">关注</th>
                            <th style="width: 100px">录音类型</th>
                            <th style="width: 120px">日期时间</a></th>
                            <!--<th style="width: 80px;" title="录音时长">录音</th>-->
                            <th style="width: 80px;" title="通话时长">通话时长</th>
                            <th style="width:100px;">号码</th>
                            <th style="width:70px;">星数</th>
                            <th style="width: 200px">操作</th>
                    </tr>
                </table>
            </div>
            <div class="formation clearfix" style="border: 1px solid #e7e7e7;border-top: none;width:100%;overflow:hidden;">
                <table>
                <foreach name="data" key="key" item="val">
                    <tr>
                        <td style="width:20px;"><input type="checkbox" class="_ids" data-id="{$val.id}" name="ids[]" value="{$val['id']}" ></td>
                        <td style="width:70px;"><?php echo sprintf("%04d", $val['line_id'])?><br>{$val['portname']}</td>
                        <td style="width:70px">
                            <if condition="1 eq $val['is_flag']">
                                <i class="gold large star icon _log_attention" data-id="<?= $val['id'] ?>"></i>
                            <else />
                                <i class="empty large star icon _log_attention" data-id="<?= $val['id'] ?>"></i>
                            </if>
                        </td>
                        <td style="width: 100px;"> {$val['type']}</td>
                        <td style="width: 120px;">{$val['call_date']}</td>
                        <!--<td style="width: 80px;">{$val['recording_time']}</td>-->
                        <td style="width: 80px;">{$val['call_time']}</td>
                        <td <?php if($val['tel']) {?>onclick="popDeviceCrm(<?php echo (int)$val['id'] ?>)" <?php }?> style="width: 100px;color:#06C;cursor: pointer">{$val['tel']}</td>
                        <td style="width: 70px;" class="wavBox ">
                            <div id="LoginBox" class="score_{$val.id}">
                                <input type="hidden"  class="call_id" value='{$val['id']}'>
                                <div class="row1">
                                    记录评分<a href="javascript:;" title="关闭窗口" class="close_btn" id="closeBtn" onclick="closeDiv({$val['id']})" style="color: rgb(153, 153, 153);">×</a>
                                </div>
                                <div class="row">
                                    星级: <select name="score" class="score">
                                            <option value='1'>1星</option>
                                            <option value='2'>2星</option>
                                            <option value='3'>3星</option>
                                            <option value='4'>4星</option>
                                            <option value='5'>5星</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <a href="javascript:;" onclick="SaveScore(this);" id="loginbtn" style="opacity: 0.8;">提交</a>
                                </div>
                            </div>
                            <span class="_port_name_txt">{$val['score']}星</span>
                        </td>
                        <td style="width: 200px;">
                            <if condition="$val['files'] eq 1">
                            <a  href="{:U('Device/PlayLog',array('id'=>$val['id']))}" target="_blank" title="播放录音文件" >播放</a><i>|</i>
                            <a href="{:U('Device/DownloadLog',array('id'=>$val['id']))}" target="_blank"  title="下载录音文件">下载</a><i>|</i>
                            <!-- <a href="{:U('/Truncate/truncate',array('id'=>$val['id']))}">转换</a><i>|</i> -->
                            <a href="javascript:;" onclick="truncate({$val['id']})">转换</a><i>|</i>
                            <else />
                                文件尚未上传
                            </if>
                            <a href="javascript:void(0)" onclick="score({$val['id']})"  title="删除记录">评分</a>
                            <a href="javascript:void(0)" onclick="handleRemove({$val['id']})"  title="删除记录">删除</a>
                            
                        </td>
                    </tr>
                </foreach>
                </table>
            </div>

            <div class="pages" style="font-size: 14px;">
                {$Page}
            </div>

        </div>
       
    </div>
</div>

<include file = "./tmp/admin/Public/list_js.html" />
<script type="text/javascript" src="./public/resource/js/device.js"></script>
<script type="text/javascript">
    function score($id){
        $(".score_"+$id).css('display','block');
    }
    function closeDiv($id){
        $(".score_"+$id).css('display','none');
    }
    jeDate({
        dateCell:"#start-one",
        format:"YYYY-MM-DD hh:mm:ss",
        isinitVal:false,
        isTime:true, //isClear:false,
        okfun:function(val){}
    })
    jeDate({
        dateCell:"#start-two",
        format:"YYYY-MM-DD hh:mm:ss",
        isinitVal:false,
        isTime:true, //isClear:false,
        okfun:function(val){}
    })

    //语音转文字
    function truncate(id){   
    dialog.tip({
        msg:'确定要转换吗?',
        buttons:{
            "Ok": { text:'确定',"class": 'btn-done', click: function() { 
                ajax({
                    type: "POST",
                    dataType: 'json',
                    url: '/index.php/Truncate/truncate_hanyu',
                    data: "id="+id+"&type=0",
                    success: function(rs){
                        dialog.tip({
                            msg:rs.msg,
                            buttons:{
                                "Done": { text:'确定',"class": 'btn-done', click: function() { window.location.reload();   } }
                            }
                        });
                    }
                });
            }},
            "Cancel": { text:'取消',"class": '', click: function() {  dialog.hide(); } }
        }
        
    });
}
</script>

<script>
    //JSON对象fruit_variety模拟Ajax数据源
//    var fruit_variety = [{fruitID:1,fruitName:"苹果"},{fruitID:2,fruitName:"梨"},{fruitID:3,fruitName:"西瓜"},{fruitID:4,fruitName:"哈密瓜"},{fruitID:5,fruitName:"草莓"},{fruitID:6,fruitName:"龙眼"},{fruitID:7,fruitName:"火龙果"},{fruitID:8,fruitName:"樱桃"},{fruitID:9,fruitName:"橘子"},{fruitID:10,fruitName:"水蜜桃"}];
    var fruit_variety =[<?=$linesOption?>]
</script>
<!--<script type="text/javascript" src="./public/public/jquery/jquery-1.7.2.min.js"></script>-->
<script>
//    $(function(){
        //生成多选下拉
        function multiSelect(obj1,obj2){
            for(var i=0;i<obj2.length;i++){
                var input = document.createElement('input');
                input.setAttribute('type','checkbox');
                input.setAttribute('name','fruit_name');
                input.setAttribute('id',obj2[i].fruitID);
                input.setAttribute('value',obj2[i].fruitID);
                var label = document.createElement('label');
                label.setAttribute('for',obj2[i].fruitID);
                label.innerHTML = obj2[i].fruitName;
                var li = document.createElement('li');
                li.append(input);
                li.append(label);
                $(obj1).append(li);
            }
            var btn = document.createElement('input');
            btn.setAttribute("type","button");
            btn.className = 'select_ok1';
            btn.setAttribute("value","确定");
            var p = document.createElement('p');
            p.className = 'txt_p';
            p.append(btn);
            $(obj1).parent().append(p);
        }
        multiSelect('.multiFruit1',fruit_variety);
        $(document).click(function(){
            $('.multiFruit1').hide();//隐藏下拉框
            $('.txt_p').hide();//隐藏确认按钮
            $('.multiFruit1 input').attr('checked',false);
            var v = $('#fruits').val();
            if(v != '' && v!=undefined){
                //获取保存的选中值,并保存默认选中
                var selectedNum = v.split(',');
                for(var i=0;i < selectedNum.length;i++){
                    for(var j=0;j<$('.multiFruit1 input').size();j++){
                        if($('.multiFruit1 input').eq(j).val() == selectedNum[i]){
                            $('.multiFruit1 input').eq(j).attr("checked",true);
                        }
                    }
                }
            }
        })
        var v = $('#fruits').val();
        if(v != '' && v!=undefined){
            //获取保存的选中值,并保存默认选中
            var selectedNum = v.split(',');
            for(var i=0;i < selectedNum.length;i++){
                for(var j=0;j<$('.multiFruit1 input').size();j++){
                    if($('.multiFruit1 input').eq(j).val() == selectedNum[i]){
                        $('.multiFruit1 input').eq(j).attr("checked",true);
                    }
                }
            }
        }
        $('.box1').click(function(e){
            e = e || window.event;
            if (e.stopPropagation) {
                e.stopPropagation();
            }else{
                e.cancelBubble = true; //IE
            }
            var w = $('.multiFruit1').innerWidth();
            var t = $('.multiFruit1').innerHeight() + $('.fruit1_ul1').innerHeight()+10;
            $('.txt_p').css('width',w);
            $('.txt_p').css('top',t);
            $('.multiFruit1').show();
        })
        $('.fruit1_ul1').click(function(){
            $('.txt_p').show();
        })
        $('.select_ok1').click(function(e){
            e = e || window.event;
            if (e.stopPropagation) {
                e.stopPropagation();
            }else{
                e.cancelBubble = true; //IE
            }
            $('.multiFruit1').hide();
            $('.txt_p').hide();
            var value = '';
            var str = '';
            //将选中的值保存到value
            for(var i=0;i<$('input[name="fruit_name"]').size();i++){
                if($('input[name="fruit_name"]').eq(i).attr('checked')){
                    value += ',' + $('input[name="fruit_name"]').eq(i).attr('value');
                    str += ',' + $('input[name="fruit_name"]').eq(i).siblings('label').html();
                }
            }
            //采用substr去除第一个逗号分隔符
            value = value.substr(1);
            str = str.substr(1);
            //将value的值赋值给input隐藏域
            $('#fruits').val(value);
            //将str的值赋值给显示框隐藏域
            $('.fruit1_ul1').html(str);
        })
        function reset1() {
            $('input:text').val('');$('.fruit1_ul1').text('');$('.multiFruit1 input').attr('checked',false);document.getElementById("fruits").value=''
        }
//    })
</script>

<include file = "./tmp/Admin/Crm/index.html" />
