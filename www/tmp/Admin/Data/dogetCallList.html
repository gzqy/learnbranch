<include file = "./tmp/Admin/Public/common.html" />
<include file = "./tmp/Admin/Public/list.html" />
<div class="content" style="background-color: #fff;">
    <div class="con">
        <dl class="nav" >
            <dt><b>●</b>数据统计</dt>
            <foreach name="second_nav" item="vo">
                <if condition="$second_nav_id eq $vo['id']">
                    <dd class="bg"><a href="javascript:;"><b>●</b>{$vo.name}</a></dd>
                    <else />
                    <dd><a href="{$vo.a}"><b>●</b>{$vo.name}</a></dd>
                </if>
            </foreach>

        </dl>
        <div class="right" style="width:88.5%;">
            <div class="aps-tab-bar aps-tab-bar-type-card aps-tab-bar-align-left aps-tab-bar-size-small">
                <div class="aps-tab-bar-wrapper" style="width: 100%;">
                    <div class="aps-tab-item-wrapper">

                        <div class="aps-tab-label aps-tab-label-active aps-tab-label-col-5">
                            <span class="aps-tab-label-inner"><a class="tabs" href="javascript:;">查询结果</a></span>
                        </div>

                    </div>
                </div>
            </div>
            <form class="clearfix search" id="_form1" method="post" action="{:U('/Data/dogetCallList_excel')}">
                <div class="filter">
                    <div class="aps-widget aps-ani-transition aps-grid aps-grid-fluid aps-state-visible">
                        <!--<foreach name="_REQUEST" item="v" key='k'>-->
                        <?php foreach (I('') as $k=>$v) { if ($k=='mediav'){continue;} ?>
                        <input type="hidden" name="<?=$k?>" value="<?=$v?>">
                        <?php }?>
                        <!--</foreach>-->
                        <input type="hidden" name="excel_type" value='0'>
                        <div class="aps-ani-transition aps-grid-row aps-state-visible">
                            <div class="aps-ani-transition aps-grid-col aps-grid-col-md-24 aps-state-visible search-button" style="padding: 8px;">

                                <button type="submit" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-btn aps-btn-normal aps-size-small btn float-btn">导出本页</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <form class="clearfix search" id="_form2" method="post" action="{:U('/Data/dogetCallList_excel')}">
                <div class="filter">
                    <div class="aps-widget aps-ani-transition aps-grid aps-grid-fluid aps-state-visible">
                        <?php foreach (I('') as $k=>$v) { if ($k=='mediav'){continue;} ?>
                        <input type="hidden" name="<?=$k?>" value="<?=$v?>">
                        <?php }?>
                        <input type="hidden" name="excel_type" value='1'>
                        <div class="aps-ani-transition aps-grid-row aps-state-visible">
                            <div class="aps-ani-transition aps-grid-col aps-grid-col-md-24 aps-state-visible search-button" style="padding: 8px;">

                                <button type="submit" class="aps-ani-transition aps-widget aps-corner-tl aps-corner-tr aps-corner-bl aps-corner-br aps-btn aps-btn-normal aps-size-small btn float-btn">全部导出</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div  class="formation clearfix" style="margin-top: 10px;width:100%;overflow:hidden;">
                <table>
                    <tr>    <th style="width: 70px">设备</th>
                        <th style="width: 70px">端口</th>
                        <th style="width: 70px">关注</th>
                        <th style="width: 100px">录音类型</th>
                        <th style="width: 120px">日期时间</a></th>
                        <!--<th style="width: 80px;" title="录音时长">录音</th>-->
                        <th style="width: 80px;" title="通话时长">通话时长</th>
                        <th style="width:100px;">号码</th>
                        <th style="width: 200px">操作</th>
                    </tr>
                </table>
            </div>
            <div class="formation clearfix" style="border: 1px solid #e7e7e7;border-top: none;width:100%;overflow:hidden;">
                <table>
                    <foreach name="data" key="key" item="val">
                        <tr>
                            <td style="width: 70px">{$val.device_name}</td>
                            <td style="width:70px;"><?php echo sprintf("%04d", $val['line_id'])?><br>{$val['portname']}</td>
                            <td style="width:70px">
                                <if condition="1 eq $val['is_flag']">
                                    <i class="gold large star icon _log_attention" data-id="<?= $val['id'] ?>"></i>
                                    <else />
                                    <i class="empty large star icon _log_attention" data-id="<?= $val['id'] ?>"></i>
                                </if>
                            </td>
                            <td style="width: 100px;"> {$val['type']}</td>
                            <td style="width: 120px;">{$val['call_date']}</td>
                            <!--<td style="width: 80px;">{$val['recording_time']}</td>-->
                            <td style="width: 80px;">{$val['call_time']}</td>
                            <td style="width: 100px;">{$val['tel']}</td>
                            <td style="width: 200px;">
                                <if condition="$val['files'] eq 1">
                                    <a  href="{:U('Device/PlayLog',array('id'=>$val['id']))}" target="_blank" title="播放录音文件" >播放</a><i>|</i>
                                    <a href="{:U('Device/DownloadLog',array('id'=>$val['id']))}" target="_blank"  title="下载录音文件">下载</a><i>|</i>
                                    <!-- <a href="{:U('/Truncate/truncate',array('id'=>$val['id']))}">转换</a><i>|</i> -->
                                    <a href="javascript:;" onclick="truncate({$val['id']})">转换</a><i>|</i>
                                    <else />
                                    文件尚未上传
                                </if>
                                <a href="javascript:void(0)" onclick="handleRemove({$val['id']})"  title="删除记录">删除</a>

                            </td>
                        </tr>
                    </foreach>
                </table>
            </div>

            <div class="pages" style="font-size: 14px;">
                {$Page}
            </div>

        </div>

    </div>
</div>
<include file = "./tmp/admin/Public/list_js.html" />
<script type="text/javascript" src="./public/resource/js/device.js"></script>
<script type="text/javascript">
    jeDate({
        dateCell:"#start-one",
        format:"YYYY-MM-DD hh:mm:ss",
        isinitVal:false,
        isTime:true, //isClear:false,
        okfun:function(val){}
    })
    jeDate({
        dateCell:"#start-two",
        format:"YYYY-MM-DD hh:mm:ss",
        isinitVal:false,
        isTime:true, //isClear:false,
        okfun:function(val){}
    })

    //语音转文字
    function truncate(id){
        dialog.tip({
            msg:'确定要转换吗?',
            buttons:{
                "Ok": { text:'确定',"class": 'btn-done', click: function() {
                    ajax({
                        type: "POST",
                        dataType: 'json',
                        url: '/index.php/Truncate/truncate_hanyu',
                        data: "id="+id+"&type=0",
                        success: function(rs){
                            dialog.tip({
                                msg:rs.msg,
                                buttons:{
                                    "Done": { text:'确定',"class": 'btn-done', click: function() { window.location.reload();   } }
                                }
                            });
                        }
                    });
                }},
                "Cancel": { text:'取消',"class": '', click: function() {  dialog.hide(); } }
            }

        });
    }


    //导出表格
    function excel(){
        var start_date = "{$start_date}";
        var end_date = "{$end_date}";
        var group_id = "{$group_id}";
        var start_call_time = "{$start_call_time}";
        var end_call_time = "{$end_call_time}";
        var max_recording = "{$max_recording}";
        var min_recording = "{$min_recording}";
        var tel = "{$tel}";
        var search_line = "{$search_line}";
        var search_type = "{$search_type}";
        var keywords = "{$keywords}";
        var id = "{$id}";
        var excel = 1;
        var url = "{:U('Device/logs_excel',array('start_date'=>$start_date,'end_date'=>$end_date,'group_id'=>$group_id,'start_call_time'=>$start_call_time,'end_call_time'=>$end_call_time,'max_recording'=>$max_recording,'excel'=>1,'min_recording'=>$min_recording,'tel'=>$tel,'search_line'=>$search_line,'search_type'=>$search_type,'keywords'=>$keywords,'id'=>$id))}";
        location.href=url;

    }
</script>